name: Deployment Logic

on:
  workflow_call:
    inputs:
      target_environment:
        required: true
        type: string
        description: "The target environment (Development or Production)"
      services_to_deploy:
        required: true
        type: string
        description: "Services to deploy"
      branch_name:
        required: true
        type: string
        description: "The Git branch name to checkout"
    secrets:
      SSH_HOST:
        required: true
      SSH_USERNAME:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SSH_PORT:
        required: false
      DB_PASSWORD:
        required: true
      OIDC_CLIENT_ID:
        required: true
      OIDC_CLIENT_SECRET:
        required: true

jobs:
  deploy:
    name: Deploy Logic
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.target_environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 60m
          script: |
            set -e

            DEPLOY_TARGET="${{ inputs.services_to_deploy }}"
            BRANCH_NAME="${{ inputs.branch_name }}"

            PROJECT_ROOT="/home/ubuntu/AtomicChargeCalculator"
            DEPLOY_DIR="$PROJECT_ROOT/src/deployment"
            CHARGEFW2_DIR="$PROJECT_ROOT/ChargeFW2"

            echo "Deployment target: [$DEPLOY_TARGET] from branch [$BRANCH_NAME]"

            echo "Setting up environment variables ..."
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export OIDC_CLIENT_ID=${{ secrets.OIDC_CLIENT_ID }}
            export OIDC_CLIENT_SECRET=${{ secrets.OIDC_CLIENT_SECRET }}

            if [ "${{ inputs.target_environment }}" = "Production" ]; then
                export VITE_BASE_API_URL="https://acc.biodata.ceitec.cz:443/api/v1"
            else
                export VITE_BASE_API_URL="https://acc-dev.biodata.ceitec.cz:443/api/v1"
            fi

            cd $PROJECT_ROOT
            echo "Changed directory to $(pwd)"

            echo "Pulling latest changes ..."
            sudo git checkout $BRANCH_NAME
            sudo git fetch origin
            sudo git reset --hard origin/$BRANCH_NAME
            sudo git submodule update --recursive

            cd $DEPLOY_DIR
            echo "Changed directory to $(pwd)"

            COMPOSE_FILES="-f docker-compose.yml -f docker-compose.prod.yml"

            if [ "$DEPLOY_TARGET" = "api" ]; then
              echo "Deploying API only ..."
              docker compose $COMPOSE_FILES down api
              docker compose $COMPOSE_FILES up -d --no-deps --build --force-recreate api              
              echo "API service deployment finished."

            elif [ "$DEPLOY_TARGET" = "api including chargefw2" ]; then
              echo "Deploying API including chargefw2 ..."
              docker compose $COMPOSE_FILES down api
              
              echo "Building chargefw2 base image ..."
              docker build -t chargefw2-base:acc -f $CHARGEFW2_DIR/Dockerfile $CHARGEFW2_DIR --no-cache
              
              docker compose $COMPOSE_FILES build --no-cache api
              docker compose $COMPOSE_FILES up -d --no-deps --force-recreate api
              echo "API service deployment with ChargeFW2 finished."

            elif [ "$DEPLOY_TARGET" = "nginx" ]; then
              echo "Deploying nginx ..."
              docker compose $COMPOSE_FILES down nginx
              docker compose $COMPOSE_FILES up -d --no-deps --build --force-recreate nginx
              echo "Nginx service deployment finished."

            elif [ "$DEPLOY_TARGET" = "web" ]; then
              echo "Deploying web ..."
              docker compose $COMPOSE_FILES down web
              docker compose $COMPOSE_FILES up -d --no-deps --build --force-recreate web
              echo "Web service deployment finished."

            elif [ "$DEPLOY_TARGET" = "all" ]; then
              echo "Deploying all services ..."
              docker compose $COMPOSE_FILES down --remove-orphans
              
              echo "Building chargefw2 base image ..."
              docker build -t chargefw2-base:acc -f $CHARGEFW2_DIR/Dockerfile $CHARGEFW2_DIR --no-cache

              docker compose $COMPOSE_FILES build --no-cache
              docker compose $COMPOSE_FILES up -d --force-recreate
              echo "All services deployment finished."

            else
              echo "Error: Invalid deployment target: $DEPLOY_TARGET"
              exit 1
            fi

            echo "Pruning old untagged and unused Docker images..."
            docker image prune -f

            echo "Deployment finished successfully."
