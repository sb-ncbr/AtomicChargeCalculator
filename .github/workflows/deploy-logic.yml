name: Deployment Logic

on:
  workflow_call:
    inputs:
      target_environment:
        required: true
        type: string
      branch_name:
        required: true
        type: string
      deploy_chargefw2:
        required: true
        type: boolean
      deploy_api:
        required: true
        type: boolean
      deploy_web:
        required: true
        type: boolean
      deploy_nginx:
        required: true
        type: boolean
    secrets:
      SSH_HOST: { required: true }
      SSH_USERNAME: { required: true }
      SSH_PRIVATE_KEY: { required: true }
      SSH_PORT: { required: false }
      DB_PASSWORD: { required: true }
      OIDC_CLIENT_ID: { required: true }
      OIDC_CLIENT_SECRET: { required: true }

jobs:
  deploy:
    name: Deploy Logic
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.target_environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 60m
          script: |
            set -e

            BRANCH_NAME="${{ inputs.branch_name }}"

            PROJECT_ROOT="/home/ubuntu/AtomicChargeCalculator"
            DEPLOY_DIR="$PROJECT_ROOT/src/deployment"
            CHARGEFW2_DIR="$PROJECT_ROOT/ChargeFW2"

            echo "Deployment Branch: [$BRANCH_NAME]"

            echo "Setting up environment variables ..."
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            export OIDC_CLIENT_ID=${{ secrets.OIDC_CLIENT_ID }}
            export OIDC_CLIENT_SECRET=${{ secrets.OIDC_CLIENT_SECRET }}

            if [ "${{ inputs.target_environment }}" = "Production" ]; then
                export VITE_BASE_API_URL="https://acc.biodata.ceitec.cz:443/api/v1"
                export OIDC_BASE_URL="https://acc.biodata.ceitec.cz/"
                export OIDC_REDIRECT_URL="https://acc.biodata.ceitec.cz/api/v1/auth/callback"
                export NGINX_CONFIG_FILE="nginx.prod.conf"
            else
                export VITE_BASE_API_URL="https://acc-dev.biodata.ceitec.cz:443/api/v1"
                export OIDC_BASE_URL="https://acc-dev.biodata.ceitec.cz/"
                export OIDC_REDIRECT_URL="https://acc-dev.biodata.ceitec.cz/api/v1/auth/callback"
                export NGINX_CONFIG_FILE="nginx.dev.conf"
            fi

            cd $PROJECT_ROOT
            echo "Changed directory to $(pwd)"

            echo "Pulling latest changes ..."
            sudo git checkout $BRANCH_NAME
            sudo git fetch origin
            sudo git reset --hard origin/$BRANCH_NAME
            sudo git submodule update --recursive

            cd $DEPLOY_DIR
            echo "Changed directory to $(pwd)"

            COMPOSE_FILES="-f docker-compose.yml -f docker-compose.prod.yml"

            if [ "${{ inputs.deploy_chargefw2 }}" == "true" ]; then
                echo "Deploying ChargeFW2 Base..."
                docker build -t chargefw2-base:acc -f $CHARGEFW2_DIR/Dockerfile $CHARGEFW2_DIR --no-cache
            fi

            if [ "${{ inputs.deploy_api }}" == "true" ]; then
                echo "Deploying API..."
                docker compose $COMPOSE_FILES build --no-cache api
                docker compose $COMPOSE_FILES up -d --no-deps --force-recreate api
            fi

            if [ "${{ inputs.deploy_web }}" == "true" ]; then
                echo "Deploying Web..."
                docker compose $COMPOSE_FILES up -d --no-deps --build --force-recreate web
            fi

            if [ "${{ inputs.deploy_nginx }}" == "true" ]; then
                echo "Deploying Nginx..."
                docker compose $COMPOSE_FILES up -d --no-deps --build --force-recreate nginx
            fi

            echo "Pruning unused images..."
            docker image prune -f

            echo "Deployment finished successfully."
